<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ë¬¼í’ˆ ìˆ˜ì • - Wegive</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/header.css">

    <style>
        /* ğŸŒ¿ í…Œë§ˆ ì‹œìŠ¤í…œ (item-formê³¼ ë™ì¼) */
        :root {
            --sage-green: #5a8d7a;
            --sage-dark: #4a7565;
            --soft-sage: #e8f3ef;
            --warm-coral: #ff7e67;
            --cream-bg: #fdfcf9;
            --text-main: #374151;
        }

        body {
            background-color: var(--cream-bg);
            font-family: 'Pretendard', -apple-system, sans-serif;
            color: var(--text-main);
            padding-bottom: 80px;
        }

        /* ğŸ“ item-form/item-detailê³¼ ë™ì¼í•œ 1000px ë„ˆë¹„ ì ìš© */
        .main-wrapper {
            max-width: 1000px;
            margin: 20px auto;
            padding: 0 20px;
        }

        /* í¼ ì»¨í…Œì´ë„ˆ ë””ìì¸ */
        .form-container {
            background: white;
            padding: 40px;
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.03);
            border: 1px solid rgba(90, 141, 122, 0.1);
        }

        h3 { color: #2d4a3e; letter-spacing: -0.5px; }
        .form-label { color: var(--text-main); font-weight: 700 !important; margin-bottom: 8px; }

        /* ì…ë ¥ì°½ ì»¤ìŠ¤í…€ */
        .form-control, .form-select {
            border-radius: 12px;
            border: 1px solid #e5e7eb;
            padding: 12px 15px;
            font-size: 0.95rem;
            transition: all 0.2s ease;
            background-color: #fcfcfc;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--sage-green);
            box-shadow: 0 0 0 4px rgba(90, 141, 122, 0.1);
            background-color: white;
        }

        .form-control[readonly] {
            background-color: #f3f4f6;
            color: #6b7280;
        }

        /* ğŸ“¸ ì´ë¯¸ì§€ ì—…ë¡œë“œ UI */
        .image-preview-container {
            display: flex; gap: 12px; overflow-x: auto; padding: 5px 0 15px 0;
            scrollbar-width: none;
        }
        .image-preview-container::-webkit-scrollbar { display: none; }

        /* ğŸ“ ê¸°ë³¸ íŒŒì¼ ì…ë ¥ì°½ ìˆ¨ê¸°ê¸° */
        #imageFiles {
            display: none;
        }

        .custom-file-upload {
            display: inline-flex; align-items: center; justify-content: center;
            width: 90px; height: 90px;
            border: 2px dashed #cbd5e1;
            border-radius: 16px;
            cursor: pointer;
            color: #94a3b8;
            font-size: 28px;
            background-color: #f8fafc;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        .custom-file-upload:hover {
            border-color: var(--sage-green);
            color: var(--sage-green);
            background-color: var(--soft-sage);
            transform: translateY(-2px);
        }

        .preview-box {
            width: 90px; height: 90px;
            border-radius: 16px;
            border: none;
            background-size: cover; background-position: center;
            position: relative;
            flex-shrink: 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }
        .preview-box:hover { transform: scale(1.02); }

        .btn-remove-img {
            position: absolute; top: -6px; right: -6px;
            width: 24px; height: 24px;
            background-color: var(--warm-coral);
            color: white;
            border: 2px solid white;
            border-radius: 50%;
            font-size: 12px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: 0.2s;
        }
        .btn-remove-img:hover { background-color: #ff5e45; transform: scale(1.1); }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-primary {
            background-color: var(--sage-green);
            border: none;
            border-radius: 12px;
            padding: 14px;
            font-size: 1.1rem;
            box-shadow: 0 4px 12px rgba(90, 141, 122, 0.3);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            background-color: var(--sage-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(90, 141, 122, 0.4);
        }

        .btn-outline-secondary {
            border-radius: 12px;
            padding: 14px;
            border: 2px solid #e5e7eb;
            color: #6b7280;
            font-weight: 700;
            background: white;
        }
        .btn-outline-secondary:hover {
            background-color: #f3f4f6;
            color: #374151;
            border-color: #d1d5db;
        }

        .btn-search-addr {
            border: 1px solid var(--sage-green);
            color: var(--sage-green);
            background: white;
            border-radius: 0 12px 12px 0;
            font-weight: 700;
            padding: 0 20px;
            transition: 0.3s;
        }
        .btn-search-addr:hover {
            background-color: var(--sage-green);
            color: white;
        }
        .input-group .form-control { border-radius: 12px 0 0 12px; }

        #map {
            border-radius: 16px !important;
            border: 2px solid #e8f3ef !important;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.05);
        }

        @media (max-width: 768px) {
            .main-wrapper { margin: 10px auto; padding: 0 10px; }
            .form-container { padding: 25px; border-radius: 20px; }
        }
    </style>
</head>
<body>

<div class="container">
    <div th:replace="~{fragments/header :: header}"></div>
</div>

<div class="main-wrapper">
    <div class="form-container">
        <h3 class="fw-bold mb-4 text-center">âœï¸ ë¬¼í’ˆ ì •ë³´ ìˆ˜ì •</h3>
        <p class="text-center text-muted small mb-5">ìˆ˜ì •ëœ ë‚´ìš©ì€ ì¦‰ì‹œ ë°˜ì˜ë©ë‹ˆë‹¤</p>

        <form id="editForm">
            <input type="hidden" id="itemId" th:value="${item.itemId}">

            <div class="mb-5">
                <label class="form-label">ìƒí’ˆ ì´ë¯¸ì§€ <span style="font-size:0.85rem; color:var(--warm-coral); font-weight:normal;">(ìµœëŒ€ 5ì¥, ìˆ˜ì • ì‹œ ê¸°ì¡´ ì´ë¯¸ì§€ ëŒ€ì²´)</span></label>
                <div class="image-preview-container">
                    <label for="imageFiles" class="custom-file-upload shadow-sm"><i class="bi bi-camera-fill"></i></label>
                    <input type="file" id="imageFiles" multiple accept="image/*" onchange="previewImages(this)">
                    <div id="previewList" class="d-flex gap-2"></div>
                </div>
            </div>

            <div class="mb-4">
                <label for="title" class="form-label">ì œëª©</label>
                <input type="text" class="form-control" id="title" name="title"
                       th:value="${item.title}" placeholder="ì œëª© ì…ë ¥" required>
            </div>

            <div class="mb-4">
                <label for="category" class="form-label">ì¹´í…Œê³ ë¦¬</label>
                <select class="form-select" id="category" name="category" style="cursor: pointer;">
                    <option value="ë””ì§€í„¸/ê°€ì „" th:selected="${item.category == 'ë””ì§€í„¸/ê°€ì „'}">ë””ì§€í„¸/ê°€ì „</option>
                    <option value="ê°€êµ¬/ì¸í…Œë¦¬ì–´" th:selected="${item.category == 'ê°€êµ¬/ì¸í…Œë¦¬ì–´'}">ê°€êµ¬/ì¸í…Œë¦¬ì–´</option>
                    <option value="ìƒí™œ/ê°€ê³µì‹í’ˆ" th:selected="${item.category == 'ìƒí™œ/ê°€ê³µì‹í’ˆ'}">ìƒí™œ/ê°€ê³µì‹í’ˆ</option>
                    <option value="ì˜ë¥˜/ì¡í™”" th:selected="${item.category == 'ì˜ë¥˜/ì¡í™”'}">ì˜ë¥˜/ì¡í™”</option>
                    <option value="ë„ì„œ/í‹°ì¼“/ìŒë°˜" th:selected="${item.category == 'ë„ì„œ/í‹°ì¼“/ìŒë°˜'}">ë„ì„œ/í‹°ì¼“/ìŒë°˜</option>
                    <option value="ê¸°íƒ€" th:selected="${item.category == 'ê¸°íƒ€'}">ê¸°íƒ€</option>
                </select>
            </div>

            <div class="mb-4">
                <label class="form-label">ë‚˜ëˆ” í¬ë§ ì¥ì†Œ</label>
                <div class="input-group mb-3">
                    <input type="text" class="form-control" id="addressName" name="addressName"
                           th:value="${item.addressName}" placeholder="ì£¼ì†Œ ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”" readonly required>
                    <button type="button" class="btn btn-search-addr" onclick="searchAddress()">
                        <i class="bi bi-search"></i> ê²€ìƒ‰
                    </button>
                </div>

                <div id="map" style="width:100%; height:300px; display:none; margin-bottom:10px;"></div>

                <input type="hidden" id="itemLat" name="itemLat" th:value="${item.itemLat}">
                <input type="hidden" id="itemLon" name="itemLon" th:value="${item.itemLon}">
            </div>

            <div class="mb-5">
                <label for="description" class="form-label">ìì„¸í•œ ì„¤ëª…</label>
                <textarea class="form-control" id="description" name="description" rows="6"
                          th:text="${item.description}" placeholder="ë‚´ìš© ì…ë ¥" required style="resize: none;"></textarea>
            </div>

            <div class="d-grid gap-3">
                <button type="button" class="btn btn-primary fw-bold" onclick="submitEdit()">ìˆ˜ì • ì™„ë£Œ</button>
                <button type="button" class="btn btn-outline-secondary fw-bold text-center" onclick="history.back()">ì·¨ì†Œ</button>
            </div>
        </form>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=${YOUR_KAKAO_KEY}&libraries=services"></script>

<script>
    /* ì§€ë„ ì„¤ì • ë° ì´ˆê¸°í™” (ìˆ˜ì • í˜ì´ì§€ ì „ìš© ë¡œì§ ìœ ì§€) */
    let mapContainer = document.getElementById('map');
    let mapOption = { center: new kakao.maps.LatLng(37.566826, 126.9786567), level: 3 };
    let map = null, marker = null, geocoder = null;

    document.addEventListener("DOMContentLoaded", function() {
        if (window.kakao && kakao.maps && kakao.maps.services) {
            geocoder = new kakao.maps.services.Geocoder();

            // â­ [ìˆ˜ì • í˜ì´ì§€ í•µì‹¬] ê¸°ì¡´ ì¢Œí‘œê°€ ìˆìœ¼ë©´ ì§€ë„ ë°”ë¡œ í‘œì‹œ
            const savedLat = document.getElementById('itemLat').value;
            const savedLon = document.getElementById('itemLon').value;

            if (savedLat && savedLon) {
                const coords = new kakao.maps.LatLng(savedLat, savedLon);
                mapOption.center = coords;
                mapContainer.style.display = "block";
                map = new kakao.maps.Map(mapContainer, mapOption);
                marker = new kakao.maps.Marker({ map: map, position: coords });
            }
        } else {
            console.error("âŒ ì¹´ì¹´ì˜¤ ì§€ë„ APIê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.");
        }
    });

    function searchAddress() {
        new daum.Postcode({
            oncomplete: function(data) {
                const addr = data.address;
                document.getElementById("addressName").value = addr;

                if (!geocoder) {
                    Swal.fire('API ì˜¤ë¥˜', 'ì§€ë„ ê¸°ëŠ¥ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    return;
                }

                geocoder.addressSearch(addr, function(result, status) {
                    if (status === kakao.maps.services.Status.OK) {
                        const coords = new kakao.maps.LatLng(result[0].y, result[0].x);

                        document.getElementById('itemLat').value = result[0].y;
                        document.getElementById('itemLon').value = result[0].x;

                        mapContainer.style.display = "block";
                        if (!map) {
                            map = new kakao.maps.Map(mapContainer, mapOption);
                        }
                        map.relayout();
                        map.setCenter(coords);

                        if (marker) marker.setMap(null);
                        marker = new kakao.maps.Marker({ map: map, position: coords });
                    } else {
                        Swal.fire('ì¢Œí‘œ ë³€í™˜ ì‹¤íŒ¨', 'í•´ë‹¹ ì£¼ì†Œì˜ ìœ„ì¹˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                    }
                });
            }
        }).open();
    }

    /* ì´ë¯¸ì§€ ë° ì „ì†¡ ë¡œì§ (item-formê³¼ ë™ì¼í•œ ë¡œì§ + submitEdit í•¨ìˆ˜ëª… ìœ ì§€) */
    let totalFiles = [];
    const MAX_FILE_COUNT = 5;

    function previewImages(input) {
        const newFiles = Array.from(input.files);

        if (totalFiles.length + newFiles.length > MAX_FILE_COUNT) {
            Swal.fire({
                title: 'ê²½ê³ ',
                html: `ì´ë¯¸ì§€ëŠ” ìµœëŒ€ ${MAX_FILE_COUNT}ì¥ì…ë‹ˆë‹¤.<br>í˜„ì¬ <b>${totalFiles.length}ì¥</b>ì´ ë“±ë¡ë˜ì–´ ìˆìŠµë‹ˆë‹¤.`,
                icon: 'warning'
            });
            input.value = "";
            return;
        }

        totalFiles = totalFiles.concat(newFiles);
        updatePreviewUI();
        input.value = "";
    }

    function updatePreviewUI() {
        const previewList = document.getElementById('previewList');
        previewList.innerHTML = "";

        totalFiles.forEach((file, index) => {
            const reader = new FileReader();
            reader.onload = e => {
                const div = document.createElement('div');
                div.className = 'preview-box';
                div.style.backgroundImage = `url(${e.target.result})`;

                const btn = document.createElement('button');
                btn.className = 'btn-remove-img';
                btn.innerHTML = '<i class="bi bi-x"></i>';
                btn.type = 'button';
                btn.onclick = function() { removeImage(index); };

                div.appendChild(btn);
                previewList.appendChild(div);
            };
            reader.readAsDataURL(file);
        });
    }

    function removeImage(index) {
        totalFiles.splice(index, 1);
        updatePreviewUI();
    }

    // [ì¤‘ìš”] ìˆ˜ì • ì „ì†¡ í•¨ìˆ˜ (submitEdit ìœ ì§€, URLì— itemId í¬í•¨)
    function submitEdit() {
        const form = document.getElementById('editForm');
        // itemId ê°€ì ¸ì˜¤ê¸° (Thymeleafë¡œ ë Œë”ë§ëœ hidden input)
        const itemId = document.getElementById('itemId').value;

        if (!form.title.value.trim() || !form.addressName.value.trim() || !form.description.value.trim()) {
            return Swal.fire('í•„ìˆ˜ ì…ë ¥', 'ëª¨ë“  ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
        }

        const lat = document.getElementById('itemLat').value;
        const lon = document.getElementById('itemLon').value;
        if (!lat || !lon) {
            return Swal.fire('ìœ„ì¹˜ ì •ë³´ ëˆ„ë½', 'ì£¼ì†Œ ê²€ìƒ‰ì„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
        }

        Swal.fire({ title: 'ìˆ˜ì • ì¤‘...', didOpen: () => Swal.showLoading() });

        const formData = new FormData();

        formData.append('title', form.title.value);
        formData.append('category', form.category.value);
        formData.append('addressName', form.addressName.value);
        formData.append('itemLat', lat);
        formData.append('itemLon', lon);
        formData.append('description', form.description.value);

        if (totalFiles.length > 0) {
            totalFiles.forEach(file => {
                formData.append('imageFiles', file);
            });
        }

        // ìˆ˜ì • API í˜¸ì¶œ
        fetch(`/api/items/${itemId}/edit`, {
            method: 'POST',
            body: formData
        })
        .then(async response => {
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(errorText);
            }
            return response.text();
        })
        .then(() => {
            Swal.fire({
                title: 'ìˆ˜ì • ì™„ë£Œ!',
                text: 'ë¬¼í’ˆ ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.',
                icon: 'success',
                confirmButtonColor: '#5a8d7a'
            }).then(() => location.href = `/items/${itemId}`); // ìˆ˜ì • í›„ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
        })
        .catch(err => {
            Swal.fire('ì‹¤íŒ¨', err.message, 'error');
        });
    }
</script>
</body>
</html>