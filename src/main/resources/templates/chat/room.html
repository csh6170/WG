<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Wegive ì±„íŒ…</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/header.css">

    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* ğŸŒ¿ í…Œë§ˆ ì‹œìŠ¤í…œ (item-detail.htmlê³¼ ë™ì¼) */
        :root {
            --sage-green: #5a8d7a;
            --warm-coral: #ff7e67;
            --cream-bg: #fdfcf9;
            --text-main: #374151;
            --chat-my-bg: #5a8d7a;      /* ë‚´ ë©”ì‹œì§€ ë°°ê²½ (ì„¸ì´ì§€ ê·¸ë¦°) */
            --chat-other-bg: #f3f4f6;   /* ìƒëŒ€ ë©”ì‹œì§€ ë°°ê²½ (ì—°íšŒìƒ‰) */
        }

        body {
            background-color: var(--cream-bg);
            font-family: 'Pretendard', -apple-system, sans-serif;
            color: var(--text-main);
            padding-bottom: 50px;
        }

        /* ğŸ“ ë©”ì¸ ë ˆì´ì•„ì›ƒ (1000px ì¤‘ì•™ ì •ë ¬) */
        .main-wrapper {
            max-width: 1000px;
            margin: 20px auto;
            padding: 0 20px;
        }

        /* ì±„íŒ…ë°© ì „ì²´ ì»¨í…Œì´ë„ˆ (í°ìƒ‰ ì¹´ë“œ ë””ìì¸) */
        .chat-room-card {
            background: white;
            border-radius: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.03);
            border: 1px solid rgba(90, 141, 122, 0.1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 75vh; /* í™”ë©´ì˜ 75% ë†’ì´ ì°¨ì§€ */
            min-height: 500px;
        }

        /* 1. ì±„íŒ… í—¤ë” (ìƒí’ˆ ì •ë³´) */
        .chat-header {
            padding: 15px 25px;
            border-bottom: 1px solid #f0f0f0;
            background-color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 10;
        }

        .item-info-box { display: flex; align-items: center; cursor: pointer; }
        .item-thumb {
            width: 50px; height: 50px;
            border-radius: 12px;
            object-fit: cover;
            border: 1px solid #eee;
            margin-right: 15px;
        }
        .item-text { display: flex; flex-direction: column; }
        .item-title { font-weight: 800; font-size: 1rem; color: #2d4a3e; margin-bottom: 2px; }
        .item-status { font-size: 0.85rem; }

        .status-ing { color: var(--sage-green); font-weight: 700; }
        .status-done { color: #999; text-decoration: line-through; }
        .status-reserved { color: #ffc107; font-weight: 700; }

        /* 2. ì±„íŒ… ì˜ì—­ (ìŠ¤í¬ë¡¤) */
        .chat-container {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            background-color: #f9fbfb; /* ì•„ì£¼ ì—°í•œ ì„¸ì´ì§€ í‹´íŠ¸ ë°°ê²½ */
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        /* ìŠ¤í¬ë¡¤ë°” ì»¤ìŠ¤í…€ */
        .chat-container::-webkit-scrollbar { width: 6px; }
        .chat-container::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 10px; }

        /* ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .message-wrapper { display: flex; flex-direction: column; max-width: 70%; }

        .message-box {
            padding: 12px 18px;
            border-radius: 20px;
            font-size: 0.95rem;
            line-height: 1.5;
            position: relative;
            word-break: break-all;
            box-shadow: 0 2px 5px rgba(0,0,0,0.03);
        }

        /* ë‚´ ë©”ì‹œì§€ (ì˜¤ë¥¸ìª½, ì„¸ì´ì§€ ê·¸ë¦°) */
        .my-message {
            align-self: flex-end;
            align-items: flex-end;
        }
        .my-message .message-box {
            background-color: var(--chat-my-bg);
            color: white;
            border-bottom-right-radius: 4px; /* ë§í’ì„  ëª¨ì–‘ */
        }

        /* ìƒëŒ€ ë©”ì‹œì§€ (ì™¼ìª½, íšŒìƒ‰) */
        .other-message {
            align-self: flex-start;
            align-items: flex-start;
        }
        .other-message .message-box {
            background-color: var(--chat-other-bg);
            color: #333;
            border: 1px solid #e5e7eb;
            border-bottom-left-radius: 4px; /* ë§í’ì„  ëª¨ì–‘ */
        }
        .sender-name {
            font-size: 0.8rem;
            color: #6b7280;
            margin-bottom: 5px;
            margin-left: 5px;
            font-weight: 600;
        }

        /* 3. ì…ë ¥ì°½ ì˜ì—­ */
        .chat-input-area {
            padding: 20px;
            background: white;
            border-top: 1px solid #f0f0f0;
            display: flex;
            gap: 12px;
            align-items: center;
        }
        .chat-input-area input {
            border-radius: 25px;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            padding: 12px 20px;
            flex-grow: 1;
        }
        .chat-input-area input:focus {
            outline: none;
            border-color: var(--sage-green);
            box-shadow: 0 0 0 3px rgba(90, 141, 122, 0.1);
        }
        .btn-send {
            background-color: var(--sage-green);
            color: white;
            border: none;
            border-radius: 50%; /* ì›í˜• ë²„íŠ¼ */
            width: 48px;
            height: 48px;
            display: flex; align-items: center; justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(90, 141, 122, 0.2);
        }
        .btn-send:hover { background-color: #4a7565; transform: scale(1.05); }
        .btn-send:disabled { background-color: #ccc; transform: none; }

        /* ë²„íŠ¼ ì»¤ìŠ¤í…€ (í—¤ë”ìš©) */
        .btn-action-coral {
            background-color: var(--warm-coral);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 700;
            padding: 6px 14px;
            font-size: 0.85rem;
        }
        .btn-action-outline {
            border: 1px solid #d1d5db;
            color: #6b7280;
            background: white;
            border-radius: 10px;
            padding: 6px 14px;
            font-size: 0.85rem;
            text-decoration: none;
        }

        @media (max-width: 768px) {
            .main-wrapper { margin: 0; padding: 0; }
            .chat-room-card {
                height: calc(100vh - 60px); /* í—¤ë” ì œì™¸ ë†’ì´ */
                border-radius: 0;
                border: none;
            }
        }
    </style>
</head>
<body>

<div class="container">
    <div th:replace="~{fragments/header :: header}"></div>
</div>

<div class="main-wrapper">
    <div class="chat-room-card">

        <div class="chat-header">
            <th:block th:if="${item != null and item.status != 'DELETE'}">
                <div class="item-info-box" th:onclick="|location.href='/items/${item.itemId}'|">
                    <img th:src="${#lists.isEmpty(item.imageUrls) ? 'https://dummyimage.com/100x100/f0f0f0/999999.png?text=No+Image' : '/images/' + item.imageUrls[0]}"
                         class="item-thumb">
                    <div class="item-text">
                        <span class="item-title" th:text="${item.title}">ìƒí’ˆ ì œëª©</span>
                        <span class="item-status">
                            <span th:if="${item.status == 'AVAILABLE'}" class="status-ing">ë‚˜ëˆ”ì¤‘</span>
                            <span th:if="${item.status == 'RESERVED'}" class="status-reserved">ì˜ˆì•½ì¤‘</span>
                            <span th:if="${item.status == 'COMPLETED'}" class="status-done">ë‚˜ëˆ”ì™„ë£Œ</span>
                            <span class="text-secondary opacity-50 mx-1">|</span>
                            <span th:text="${item.category}" class="text-muted">ì¹´í…Œê³ ë¦¬</span>
                        </span>
                    </div>
                </div>
                <div class="d-flex gap-2 align-items-center">
                    <button th:if="${item.sellerId == myUserId and item.status == 'AVAILABLE'}"
                            onclick="completeTrade()"
                            class="btn-action-coral">
                        <i class="bi bi-check-circle-fill"></i> ë‚˜ëˆ”ì™„ë£Œ
                    </button>

                    <button th:if="${item.buyerId == myUserId and item.status == 'COMPLETED' and !item.isReviewed}"
                            onclick="openReviewModal()"
                            class="btn-action-coral">
                        <i class="bi bi-pencil-fill"></i> ë‚˜ëˆ” ë°›ê¸° ì™„ë£Œ
                    </button>

                    <a th:unless="${(item.sellerId == myUserId and item.status == 'AVAILABLE') or (item.buyerId == myUserId and item.status == 'COMPLETED' and !item.isReviewed)}"
                       th:href="|/items/${item.itemId}|"
                       class="btn-action-outline">
                        ê²Œì‹œê¸€ <i class="bi bi-chevron-right"></i>
                    </a>

                    <button type="button" class="btn btn-light btn-sm text-danger rounded-circle border"
                            style="width:36px; height:36px;"
                            title="ìƒëŒ€ë°© ì‹ ê³ í•˜ê¸°" onclick="openReportModal()">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                    </button>
                </div>
            </th:block>

            <th:block th:if="${item == null or item.status == 'DELETE'}">
                <div class="item-info-box" style="cursor: default;">
                    <img src="https://dummyimage.com/100x100/f0f0f0/999999.png?text=Deleted" class="item-thumb">
                    <div class="item-text">
                        <span class="item-title text-secondary">ì‚­ì œëœ ê²Œì‹œê¸€ì…ë‹ˆë‹¤.</span>
                        <span class="item-status text-muted">ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>
                    </div>
                </div>
            </th:block>
        </div>

        <div class="chat-container" id="chatContainer">
            <div th:each="msg : ${messages}"
                 th:class="${msg.senderId == myUserId} ? 'message-wrapper my-message' : 'message-wrapper other-message'">
                <span th:if="${msg.senderId != myUserId}" class="sender-name" th:text="${msg.senderNickname}">ìƒëŒ€ë°©</span>
                <div class="message-box" th:text="${msg.message}">ëŒ€í™” ë‚´ìš©</div>
            </div>
        </div>

        <div class="chat-input-area">
            <input type="text" id="msgInput"
                   th:placeholder="${(item == null or item.status == 'DELETE')} ? 'ì‚­ì œëœ ê²Œì‹œê¸€ì…ë‹ˆë‹¤.' : (${item.status == 'COMPLETED'} ? 'ë‚˜ëˆ”ì´ ì™„ë£Œë˜ì–´ ëŒ€í™”ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ë”°ëœ»í•œ ëŒ€í™”ë¥¼ ë‚˜ëˆ ë³´ì„¸ìš”.')"
                   th:disabled="${item == null or item.status == 'DELETE' or item.status == 'COMPLETED'}"
                   onkeyup="if(window.event.keyCode==13){sendMsg()}">

            <button class="btn-send"
                    onclick="sendMsg()"
                    th:disabled="${item == null or item.status == 'DELETE' or item.status == 'COMPLETED'}">
                <i class="bi bi-send-fill"></i>
            </button>
        </div>
    </div>
</div>

<footer th:replace="~{fragments/footer :: footer}"></footer>

<div class="modal fade" id="reportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 20px; border:none;">
            <div class="modal-header border-0 pb-0">
                <h5 class="modal-title fw-bold text-danger">ğŸš¨ ì‚¬ìš©ì ì‹ ê³ </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="chatReportForm">
                    <div class="mb-3">
                        <label class="form-label fw-bold small">ì‚¬ìœ  ì„ íƒ</label>
                        <select class="form-select" id="chatReportReason" style="border-radius: 10px;">
                            <option value="ABUSIVE">ìš•ì„¤/ë¹„ë°©/ì„±í¬ë¡±</option>
                            <option value="FRAUD">ì‚¬ê¸° ì˜ì‹¬</option>
                            <option value="OTHER">ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold small">ìƒì„¸ ë‚´ìš©</label>
                        <textarea class="form-control" id="chatReportDesc" rows="3" placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." style="border-radius: 10px;"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light rounded-pill px-4" data-bs-dismiss="modal">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-danger rounded-pill px-4" onclick="submitChatReport()">ì‹ ê³ í•˜ê¸°</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.1/sockjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

<script th:inline="javascript">
    /* ê¸°ì¡´ ë¡œì§ 100% ìœ ì§€ */
    const roomId = [[${roomId}]];
    const myUserId = [[${myUserId}]];
    const itemId = [[${item != null ? item.itemId : 0}]];
    const chatPartnerId = [[${partnerId}]];

    let stompClient = null;

    connect();

    function connect() {
        const socket = new SockJS('/ws-stomp');
        stompClient = Stomp.over(socket);
        stompClient.debug = null;

        stompClient.connect({}, function (frame) {
            stompClient.subscribe('/sub/chat/room/' + roomId, function (chatMessage) {
                showChat(JSON.parse(chatMessage.body));
            });
            scrollToBottom();
        });
    }

    function sendMsg() {
        const input = document.getElementById('msgInput');
        const content = input.value.trim();

        if(content) {
            stompClient.send("/pub/chat/message", {}, JSON.stringify({
                roomId: roomId,
                senderId: myUserId,
                message: content
            }));
            input.value = '';
        }
    }

    function showChat(message) {
        const chatContainer = document.getElementById('chatContainer');

        // ğŸ”´ ì„œë²„ì—ì„œ ë³´ë‚¸ ì¢…ë£Œ ì‹ í˜¸ ê°ì§€ ì‹œ ì¦‰ì‹œ UI ì°¨ë‹¨
        if (message.message === "STATUS_CHANGED_TO_COMPLETED") {
            disableChatInput("ë‚˜ëˆ”ì´ ì™„ë£Œë˜ì–´ ëŒ€í™”ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
            return;
        }

        let html = '';
        if (message.senderId === myUserId) {
            html = `<div class="message-wrapper my-message">
                        <div class="message-box">${message.message}</div>
                    </div>`;
        } else {
            html = `<div class="message-wrapper other-message">
                        <span class="sender-name">${message.senderNickname}</span>
                        <div class="message-box">${message.message}</div>
                    </div>`;
        }
        chatContainer.insertAdjacentHTML('beforeend', html);
        scrollToBottom();
    }

    // ì…ë ¥ í•„ë“œì™€ ë²„íŠ¼ì„ ë¹„í™œì„±í™”í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
    function disableChatInput(placeholderText) {
        const input = document.getElementById('msgInput');
        const btn = document.querySelector('.btn-send');

        if (input) {
            input.disabled = true;
            input.placeholder = placeholderText;
        }
        if (btn) {
            btn.disabled = true;
        }
    }

    function scrollToBottom() {
        const chatContainer = document.getElementById('chatContainer');
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // ë‚˜ëˆ” ì™„ë£Œ ê¸°ëŠ¥
    function completeTrade() {
        Swal.fire({
            title: 'ì´ ì‚¬ëŒì—ê²Œ ë‚˜ëˆ”ì„ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',
            text: "ì™„ë£Œ í›„ì—ëŠ” ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.",
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'ë„¤, ì™„ë£Œí•©ë‹ˆë‹¤',
            confirmButtonColor: '#5a8d7a', // í…Œë§ˆ ì»¬ëŸ¬ ì ìš©
            cancelButtonText: 'ì·¨ì†Œ'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/api/items/${itemId}/status?status=COMPLETED&buyerId=${chatPartnerId}`, {
                    method: 'PATCH'
                })
                .then(res => {
                    if (res.ok) {
                        Swal.fire('ì™„ë£Œ!', 'ë‚˜ëˆ”ì´ í™•ì •ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success')
                        .then(() => location.reload());
                    } else {
                        res.text().then(msg => Swal.fire('ì˜¤ë¥˜', msg, 'error'));
                    }
                });
            }
        });
    }

    // í›„ê¸° ì‘ì„± ê¸°ëŠ¥
    function openReviewModal() {
        Swal.fire({
            title: 'ë‚˜ëˆ”ì€ ì–´ë– ì…¨ë‚˜ìš”?',
            text: "ë‚˜ëˆ” ë°›ê¸° ì™„ë£Œë¥¼ í•˜ì‹œë©´ ìƒëŒ€ë°©ì˜ ë§¤ë„ˆì˜¨ë„ê°€ ì˜¬ë¼ê°‘ë‹ˆë‹¤!",
            icon: 'heart', // icon ì§€ì› ì—¬ë¶€ í™•ì¸ í•„ìš”í•˜ì§€ë§Œ ë³´í†µ success/info ì”€
            showCancelButton: true,
            confirmButtonText: 'ìµœê³ ì˜ˆìš”! ğŸ‘',
            confirmButtonColor: '#ff7e67', // ì›œ ì½”ë„ ì ìš©
            cancelButtonText: 'ë‹«ê¸°'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/api/items/${itemId}/review`, { method: 'POST' })
                .then(async res => {
                    const msg = await res.text();
                    if (res.ok) {
                        Swal.fire('ì „ì†¡ ì™„ë£Œ', msg, 'success').then(() => location.reload());
                    } else {
                        Swal.fire('ì‹¤íŒ¨', msg, 'error');
                    }
                });
            }
        });
    }

    /* ì‹ ê³  ìŠ¤í¬ë¦½íŠ¸ */
    function openReportModal() {
        const modal = new bootstrap.Modal(document.getElementById('reportModal'));
        modal.show();
    }

    function submitChatReport() {
        const reason = document.getElementById('chatReportReason').value;
        const description = document.getElementById('chatReportDesc').value;

        const data = {
            reportedUserId: chatPartnerId,
            itemId: itemId || 0,
            reason: reason,
            description: description + ` (ì±„íŒ…ë°© ID: ${roomId})`
        };

        fetch(`/api/reports?userId=${myUserId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        })
        .then(res => {
            if (res.ok) {
                Swal.fire('ì ‘ìˆ˜ ì™„ë£Œ', 'ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success').then(() => {
                    const modal = bootstrap.Modal.getInstance(document.getElementById('reportModal'));
                    modal.hide();
                    document.getElementById('chatReportForm').reset();
                });
            } else {
                Swal.fire('ì˜¤ë¥˜', 'ì‹ ê³  ì ‘ìˆ˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
            }
        });
    }
</script>
</body>
</html>