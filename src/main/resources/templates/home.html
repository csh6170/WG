<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Wegive - ë”°ëœ»í•œ ë‚˜ëˆ”</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/header.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        /* ê¸°ë³¸ ë°°ê²½ ë° í°íŠ¸ ì„¤ì • */
        body {
            background-color: #fdfcf9; /* ë”°ëœ»í•œ í¬ë¦¼ìƒ‰ ë°°ê²½ */
            color: #374151;
            font-family: 'Pretendard', -apple-system, sans-serif;
        }

        /* íˆì–´ë¡œ ì„¹ì…˜ (ì´ë¯¸ì§€ ëŠë‚Œì˜ ë°°ë„ˆ ì¶”ê°€) */
        .hero-banner {
            background: linear-gradient(rgba(0,0,0,0.3), rgba(0,0,0,0.3)),
                        url('https://images.unsplash.com/photo-1556745753-b2904692b3cd?auto=format&fit=crop&w=1200&q=80'); /* ë‚˜ëˆ” ì´ë¯¸ì§€ */
            background-size: cover;
            background-position: center;
            border-radius: 2rem;
            padding: 60px 20px;
            text-align: center;
            color: white;
            margin-bottom: 40px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }

        .hero-banner h1 { font-weight: 800; font-size: 2.5rem; margin-bottom: 15px; text-shadow: 2px 2px 4px rgba(0,0,0,0.3); }
        .hero-banner .btn-coral { background-color: #ff7e67; border: none; color: white; padding: 12px 30px; border-radius: 25px; font-weight: bold; }

        /* ë‚˜ëˆ” ì¹´ë“œ ë””ìì¸ (ì´ë¯¸ì§€ í˜•íƒœ ë°˜ì˜) */
        .card {
            border: none;
            border-radius: 1.5rem;
            background: white;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); /* ë¶€ë“œëŸ¬ìš´ ê·¸ë¦¼ì */
            transition: all 0.3s ease;
        }
        .card:hover { transform: translateY(-10px); box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
        .card-img-top { border-radius: 1.5rem 1.5rem 0 0; height: 200px; }

        /* í…ìŠ¤íŠ¸ ë° ìœ„ì¹˜ ì •ë³´ */
        .item-title { color: #2d4a3e; font-weight: 700; } /* ì„¸ì´ì§€ ê·¸ë¦° í†¤ */
        .item-addr {
            color: #6b7280;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            gap: 4px;

            /* í•µì‹¬ ì¶”ê°€ ì†ì„± */
            max-width: 70%;       /* ë¶€ëª¨ ê³µê°„ì˜ 70%ê¹Œì§€ë§Œ ì°¨ì§€ (ë‚˜ë¨¸ì§€ëŠ” ì¡°íšŒìˆ˜ ê³µê°„) */
            white-space: nowrap;  /* ì¤„ë°”ê¿ˆ ê°•ì œ ê¸ˆì§€ */
            overflow: hidden;     /* ë„˜ì¹˜ëŠ” í…ìŠ¤íŠ¸ ìˆ¨ê¹€ */
        }
        .item-addr span {
            overflow: hidden;
            text-overflow: ellipsis; /* ë„˜ì¹˜ë©´ ... ì²˜ë¦¬ */
            white-space: nowrap;
        }
        .item-addr i {
            flex-shrink: 0;
            color: #5a8d7a;
        }

        /* ğŸ“ ì¹´í…Œê³ ë¦¬ ë°°ì§€: ë” ë‘¥ê¸€ê³  ì€ì€í•œ ì„¸ì´ì§€ í†¤ìœ¼ë¡œ ë³€ê²½ */
        .category-badge {
            background-color: #e8f3ef; /* ì—°í•œ ì„¸ì´ì§€ ê·¸ë¦° */
            color: #5a8d7a;           /* ë©”ì¸ ì„¸ì´ì§€ ê·¸ë¦° */
            border: none;             /* í…Œë‘ë¦¬ ì œê±°ë¡œ ê¹”ë”í•˜ê²Œ */
            border-radius: 8px;       /* ì•½ê°„ ë‘¥ê·¼ ì§ì‚¬ê°í˜• */
            padding: 4px 10px;
            font-size: 0.75rem;
            font-weight: 700;
        }

        /* ê¸€ì“°ê¸° ë²„íŠ¼ (+) */
        .write-btn {
            background: linear-gradient(135deg, #5a8d7a, #4a7565);
            box-shadow: 0 8px 16px rgba(90, 141, 122, 0.3);
        }
        /* ğŸ“ ìƒíƒœ ë°°ì§€ (ì˜ˆì•½ì¤‘/ë‚˜ëˆ”ì™„ë£Œ): ì¹´ë“œ ì´ë¯¸ì§€ ìœ„ì— ì˜¬ë¼ê°€ëŠ” ìŠ¤íƒ€ì¼ */
        .status-badge {
            position: absolute;
            top: 12px;
            left: 12px;
            padding: 5px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 800;
            color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            z-index: 2;
        }

        /* ì˜ˆì•½ì¤‘: í…Œë§ˆì˜ ë©”ì¸ì¸ ì„¸ì´ì§€ ê·¸ë¦° ì ìš© */
        .bg-reserved {
            background-color: #5a8d7a;
            opacity: 0.95;
        }

        /* ë‚˜ëˆ”ì™„ë£Œ: ì°¨ë¶„í•œ ì›œê·¸ë ˆì´ ì ìš© */
        .bg-completed {
            background-color: #6b7280;
            opacity: 0.9;
        }
    </style>
</head>
<body>

<div class="container mb-5">

    <div th:replace="~{fragments/header :: header}"></div>

    <div class="row mb-4 g-2">
        <div class="col-4 col-md-3">
            <select id="categorySelect" class="form-select shadow-sm border-0" onchange="searchItems()" style="border-radius: 0.75rem;">
                <option value="">ì „ì²´ ì¹´í…Œê³ ë¦¬</option>
                <option value="ë””ì§€í„¸/ê°€ì „">ë””ì§€í„¸/ê°€ì „</option>
                <option value="ê°€êµ¬/ì¸í…Œë¦¬ì–´">ê°€êµ¬/ì¸í…Œë¦¬ì–´</option>
                <option value="ìƒí™œ/ê°€ê³µì‹í’ˆ">ìƒí™œ/ê°€ê³µì‹í’ˆ</option>
                <option value="ì˜ë¥˜/ì¡í™”">ì˜ë¥˜/ì¡í™”</option>
                <option value="ë„ì„œ/í‹°ì¼“/ìŒë°˜">ë„ì„œ/í‹°ì¼“/ìŒë°˜</option>
                <option value="ê¸°íƒ€">ê¸°íƒ€</option>
            </select>
        </div>
        <div class="col-8 col-md-9">
            <div class="input-group shadow-sm" style="border-radius: 0.75rem; overflow: hidden;">
                <input type="text" id="keywordInput" class="form-control border-0" placeholder="ì–´ë–¤ ë‚˜ëˆ”ì„ ì°¾ìœ¼ì„¸ìš”?"
                       onkeyup="if(window.event.keyCode==13){searchItems()}">
                <button class="btn btn-light border-start" type="button" onclick="resetSearch()" title="ê²€ìƒ‰ ì´ˆê¸°í™”">
                    <i class="bi bi-arrow-counterclockwise text-secondary"></i>
                </button>
                <button class="btn btn-primary px-4" onclick="searchItems()"><i class="bi bi-search"></i></button>
            </div>
        </div>
        <div class="hero-banner">
            <h1>ê°€ê¹Œìš´ ì´ì›ƒê³¼ ë‚˜ëˆ ë³´ì„¸ìš”</h1>
            <p class="fs-5">ìš°ë¦¬ ë™ë„¤ì˜ ë”°ëœ»í•œ ë‚˜ëˆ” í”Œë«í¼, WeGive</p>
            <button class="btn btn-coral mt-3" onclick="location.href='/items/new'">ì§€ê¸ˆ ë‚˜ëˆ”í•˜ê¸°</button>
        </div>
    </div>

    <h3 class="fw-bold mb-4 ps-1" style="color: #374151;">ğŸ”¥ ë°©ê¸ˆ ì˜¬ë¼ì˜¨ ë‚˜ëˆ”</h3>

    <div class="row row-cols-1 row-cols-md-3 row-cols-lg-4 g-4" id="itemList">
    </div>

    <div class="text-center mt-5 mb-5">
        <button id="loadMoreBtn" class="btn btn-outline-primary rounded-pill px-5 py-2 shadow-sm fw-bold"
                onclick="loadMore()" style="display: none;">
            ë”ë³´ê¸° <i class="bi bi-chevron-down"></i>
        </button>
    </div>

    <div id="noResult" class="text-center w-100 mt-5 py-5" style="display: none;">
        <div style="font-size: 4rem;">ğŸŒ±</div>
        <h4 class="fw-bold mt-3 text-dark">ì¡°ê±´ì— ë§ëŠ” ë‚˜ëˆ”ì´ ì—†ì–´ìš”</h4>
        <p class="text-secondary">ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¡œ ì°¾ì•„ë³´ì‹œê² ì–´ìš”?</p>
    </div>

</div>

<a th:if="${session.userId != null}" href="/items/new" class="btn write-btn text-white text-decoration-none" title="ë‚˜ëˆ”í•˜ê¸°">+</a>
<a sec:authorize="hasRole('ADMIN')" href="/admin"
   class="btn btn-dark text-white text-decoration-none shadow"
   title="ê´€ë¦¬ì í˜ì´ì§€"
   style="position: fixed; bottom: 110px; right: 37px; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; z-index: 1000;">
    <i class="bi bi-shield-lock-fill fs-5"></i>
</a>

<footer th:replace="~{fragments/footer :: footer}"></footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    /*<![CDATA[*/
    const currentUserId = [[${session.userId}]]; // ì„¸ì…˜ ID ê°€ì ¸ì˜¤ê¸°
    /*]]>*/

    // ==========================================
    //  í˜ì´ì§• ë° ê²€ìƒ‰ ë¡œì§ (ìˆ˜ì •ë¨)
    // ==========================================
    let currentPage = 0;   // í˜„ì¬ í˜ì´ì§€ ë²ˆí˜¸
    let isLastPage = false; // ë§ˆì§€ë§‰ í˜ì´ì§€ì¸ì§€ ì—¬ë¶€
    let isLoading = false; // ì¤‘ë³µ ìš”ì²­ ë°©ì§€

    document.addEventListener("DOMContentLoaded", () => {
        // 1. ê¸°ì¡´ ë¡œì§: ì´ˆê¸° ì•„ì´í…œ ë¡œë”©
        loadItems(true);

        // 2. [ì¶”ê°€] ë¡œê·¸ì¸ ì°¨ë‹¨ ì•Œë¦¼ ì²´í¬ ë¡œì§ í˜¸ì¶œ
        checkLoginError();

        // 3. [ì¶”ê°€] ì‹ ê³  ê²°ê³¼ ì•Œë¦¼ ì²´í¬ (ë¡œê·¸ì¸ í•œ ê²½ìš°ë§Œ)
        if (currentUserId) {
            checkReportNotifications();
        }
    });
    /**
     * URL íŒŒë¼ë¯¸í„° ì²´í¬ ë° ì•Œë¦¼/ëª¨ë‹¬ í‘œì‹œ
     * (banned, login_required, access_denied ì²˜ë¦¬)
     */
    function checkLoginError() {
        const urlParams = new URLSearchParams(window.location.search);
        const error = urlParams.get('error');

        // 1. ì´ìš© ì •ì§€ëœ ê³„ì • ì•Œë¦¼
        if (error === 'banned') {
            Swal.fire({
                icon: 'error',
                title: 'ğŸš« ì´ìš© ì •ì§€ëœ ê³„ì •',
                html: 'ê´€ë¦¬ìì— ì˜í•´ <b>ì„œë¹„ìŠ¤ ì´ìš©ì´ ì œí•œ</b>ë˜ì—ˆìŠµë‹ˆë‹¤.<br>ë¡œê·¸ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.',
                confirmButtonColor: '#d33',
                confirmButtonText: 'í™•ì¸',
                allowOutsideClick: false // ë°°ê²½ í´ë¦­í•´ì„œ ë‹«ê¸° ë°©ì§€
            }).then(() => {
                // ì•Œë¦¼ í™•ì¸ í›„ URL ê¹”ë”í•˜ê²Œ ì •ë¦¬
                const newUrl = window.location.pathname;
                window.history.replaceState({}, document.title, newUrl);
            });
        }
        // 2. [ì¶”ê°€] ë¡œê·¸ì¸ í•„ìš” ì‹œ ëª¨ë‹¬ ìë™ ì˜¤í”ˆ (Spring Security ì—°ë™)
        else if (error === 'login_required') {
            Swal.fire({
                icon: 'warning',
                title: 'ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤',
                text: 'í•´ë‹¹ ê¸°ëŠ¥ì„ ì´ìš©í•˜ì‹œë ¤ë©´ ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.',
                showCancelButton: true,
                confirmButtonText: 'ë¡œê·¸ì¸',
                cancelButtonText: 'ì·¨ì†Œ'
            }).then((result) => {
                if (result.isConfirmed) {
                    // ë¡œê·¸ì¸ ëª¨ë‹¬ ì—´ê¸° (Bootstrap Modal API)
                    // home.htmlì´ë‚˜ header fragmentì— id="loginModal"ì¸ ëª¨ë‹¬ì´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
                    const modalEl = document.getElementById('loginModal');
                    if (modalEl) {
                        const modal = new bootstrap.Modal(modalEl);
                        modal.show();
                    }
                }
            });
            // URL ì •ë¦¬
            window.history.replaceState({}, document.title, window.location.pathname);
        }
        // 3. [ì¶”ê°€] ê¶Œí•œ ì—†ìŒ (ì¼ë°˜ ìœ ì €ê°€ ê´€ë¦¬ì í˜ì´ì§€ ì ‘ê·¼ ë“±)
        else if (error === 'access_denied') {
            Swal.fire({
                icon: 'error',
                title: 'ì ‘ê·¼ ê±°ë¶€',
                text: 'í•´ë‹¹ í˜ì´ì§€ì— ì ‘ê·¼í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'
            });
            window.history.replaceState({}, document.title, window.location.pathname);
        }
    }

    // ê²€ìƒ‰/í•„í„° ë³€ê²½ ì‹œ í˜¸ì¶œ
    function searchItems() {
        loadItems(true);
    }

    // ì´ˆê¸°í™” ë²„íŠ¼
    function resetSearch() {
        document.getElementById('categorySelect').value = '';
        document.getElementById('keywordInput').value = '';
        loadItems(true);
    }

    // ë”ë³´ê¸° ë²„íŠ¼ í´ë¦­ ì‹œ í˜¸ì¶œ
    function loadMore() {
        if (!isLastPage && !isLoading) {
            loadItems(false);
        }
    }

    /**
     * ìƒí’ˆ ë¡œë”© í•¨ìˆ˜
     * @param {boolean} isReset - trueë©´ ëª©ë¡ì„ ì‹¹ ë¹„ìš°ê³  ì²˜ìŒë¶€í„°(0í˜ì´ì§€) ë¡œë”©
     */
    function loadItems(isReset) {
    if (isLoading) return;
    isLoading = true;

    const category = document.getElementById('categorySelect').value;
    const keyword = document.getElementById('keywordInput').value;
    const list = document.getElementById('itemList');
    const loadMoreBtn = document.getElementById('loadMoreBtn');
    const noResult = document.getElementById('noResult');

    // ë¦¬ì…‹ì´ë©´ í˜ì´ì§€ 0ìœ¼ë¡œ ì´ˆê¸°í™”
    if (isReset) {
        currentPage = 0;
        isLastPage = false;
        list.innerHTML = '';
        noResult.style.display = 'none';
        loadMoreBtn.style.display = 'none';
    }

    // í˜ì´ì§€ ìš”ì²­ URL ìƒì„± (Slice ì²˜ë¦¬)
    let url = `/api/items?page=${currentPage}&size=8`; // 8ê°œì”© ë¡œë”©
    if (category) url += `&category=${category}`;
    if (keyword) url += `&keyword=${keyword}`;

    fetch(url)
        .then(res => res.json())
        .then(slice => {
            const items = slice.content;
            isLastPage = slice.last;

            if (isReset && items.length === 0) {
                noResult.style.display = 'block';
            } else {
                noResult.style.display = 'none';
                renderItems(items);
            }

            // ë§ˆì§€ë§‰ í˜ì´ì§€ê°€ ì•„ë‹ˆë©´ ë”ë³´ê¸° ë²„íŠ¼ í‘œì‹œ
            if (!isLastPage) {
                loadMoreBtn.style.display = 'inline-block';
                currentPage++; // ë‹¤ìŒ ë¡œë”©ì„ ìœ„í•´ í˜ì´ì§€ ì¦ê°€
            } else {
                loadMoreBtn.style.display = 'none';
            }
        })
        .catch(err => console.error(err))
        .finally(() => {
            isLoading = false;
        });
}

    // ì•„ì´í…œ ê·¸ë¦¬ê¸° í•¨ìˆ˜ ë‚´ë¶€
    function renderItems(items) {
        const list = document.getElementById('itemList');

        items.forEach(item => {
            let imgUrl = 'https://dummyimage.com/600x400/f0f0f0/999999.png?text=No+Image';
            if (item.imageUrls && item.imageUrls.length > 0) {
                imgUrl = '/images/' + item.imageUrls[0];
            }

            // ğŸ“ ìˆ˜ì •ëœ ë°°ì§€ ë¡œì§: span íƒœê·¸ì— status-badge í´ë˜ìŠ¤ ì¶”ê°€
            let badgeHtml = '';
            if (item.status === 'RESERVED') {
                badgeHtml = '<span class="status-badge bg-reserved">ì˜ˆì•½ì¤‘</span>';
            } else if (item.status === 'COMPLETED') {
                badgeHtml = '<span class="status-badge bg-completed">ë‚˜ëˆ”ì™„ë£Œ</span>';
            }

            const html = `
                <div class="col">
                    <div class="card h-100" onclick="location.href='/items/${item.itemId}'">
                        <div style="position: relative;">
                            <img src="${imgUrl}" class="card-img-top" alt="ìƒí’ˆì´ë¯¸ì§€" style="filter: ${item.status === 'COMPLETED' ? 'grayscale(40%)' : 'none'}">
                            ${badgeHtml}
                        </div>
                        <div class="card-body">
                            <span class="category-badge mb-2 d-inline-block">${item.category}</span>
                            <h5 class="item-title text-truncate">${item.title}</h5>
                            <p class="item-desc text-muted small text-truncate">${item.description}</p>

                            <div class="d-flex justify-content-between align-items-center mt-3">
                                <div class="item-addr" title="${item.addressName}"> <i class="bi bi-geo-alt-fill"></i>
                                    <span>${item.addressName}</span>
                                </div>
                                <small class="text-muted flex-shrink-0">ğŸ‘€ ${item.viewCount}</small>
                            </div>

                        </div>
                    </div>
                </div>`;
            list.insertAdjacentHTML('beforeend', html);
        });
    }

    function checkReportNotifications() {
        fetch(`/api/reports/notifications?userId=${currentUserId}`)
            .then(res => res.json())
            .then(messages => {
                if (messages && messages.length > 0) {
                    // ì•Œë¦¼ì´ ì—¬ëŸ¬ ê°œì¼ ìˆ˜ ìˆìœ¼ë‹ˆ í•˜ë‚˜ì”© ë„ìš°ê±°ë‚˜, ë¬¶ì–´ì„œ ë³´ì—¬ì¤ë‹ˆë‹¤.
                    // ì—¬ê¸°ì„  ê°„ë‹¨í•˜ê²Œ ì²« ë²ˆì§¸ ì•Œë¦¼ë§Œ SweetAlertë¡œ ë„ìš°ê±°ë‚˜ ì¤„ë°”ê¿ˆìœ¼ë¡œ í•©ì¹©ë‹ˆë‹¤.
                    const fullMsg = messages.join('<br><br>');

                    Swal.fire({
                        title: 'ğŸ“¢ ì‹ ê³  ì²˜ë¦¬ ê²°ê³¼',
                        html: fullMsg, // ì¤„ë°”ê¿ˆ ì ìš©ë¨
                        icon: 'info',
                        confirmButtonText: 'í™•ì¸'
                    });
                }
            })
            .catch(err => console.error("ì•Œë¦¼ í™•ì¸ ì‹¤íŒ¨:", err));
    }
</script>
</body>
</html>