<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìƒí’ˆ ìƒì„¸ - Wegive</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/header.css">

    <style>
        :root {
            --sage-green: #5a8d7a;
            --warm-coral: #ff7e67;
            --cream-bg: #fdfcf9;
        }

        body { background-color: var(--cream-bg); padding-bottom: 100px; font-family: 'Pretendard', sans-serif; }

        .main-wrapper {
            max-width: 1000px;
            margin: 20px auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        #imageCarousel {
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            background: #fff;
        }
        .carousel-item img { height: 500px; object-fit: contain; background: #2d2d2d; }

        @media (max-width: 768px) {
            .main-wrapper { margin: 0; gap: 0; }
            #imageCarousel { border-radius: 0; }
            .carousel-item img { height: 400px; }
            .content-section, .profile-section { border-radius: 0; border-top: 1px solid #f0f0f0; }
        }

        .profile-section, .content-section {
            background: #fff;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }

        .profile-img { width: 55px; height: 55px; border-radius: 50%; object-fit: cover; margin-right: 15px; border: 1px solid #f0f0f0; }

        .manner-temp-container { text-align: right; min-width: 100px; }
        .temp-text { font-size: 1.1rem; font-weight: 800; margin-bottom: 2px; display: block; color: var(--sage-green); }
        .temp-bar-bg { width: 80px; height: 6px; background: #eee; border-radius: 10px; margin-left: auto; overflow: hidden; }
        .temp-bar-fill { height: 100%; background: var(--sage-green); transition: width 0.6s ease; }

        .temp-hot { color: #ff4d4d; } .bg-hot { background: #ff4d4d; }
        .temp-warm { color: var(--sage-green); } .bg-warm { background: var(--sage-green); }
        .temp-normal { color: #ffc107; } .bg-normal { background: #ffc107; }
        .temp-cold { color: #6c757d; } .bg-cold { background: #6c757d; }

        .bottom-bar {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            width: 95%; max-width: 1000px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(15px);
            padding: 15px 30px;
            border-radius: 25px;
            display: flex; justify-content: space-between; align-items: center;
            z-index: 1000;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(0,0,0,0.05);
        }

        @media (max-width: 768px) {
            .bottom-bar { bottom: 0; width: 100%; border-radius: 0; padding: 15px 20px; }
        }

        .btn-coral { background-color: var(--warm-coral); border: none; color: white; border-radius: 12px; font-weight: bold; }

        .status-select-custom {
            border-radius: 10px; border: 2px solid var(--sage-green);
            color: var(--sage-green); font-size: 0.85rem; padding: 5px 10px; width: 110px;
            font-weight: bold; background-color: white;
        }
    </style>
</head>
<body>

<div class="container">
    <div th:replace="~{fragments/header :: header}"></div>
</div>

<div class="main-wrapper">
    <div id="imageCarousel" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-inner" id="carouselInner"></div>
        <button class="carousel-control-prev" type="button" data-bs-target="#imageCarousel" data-bs-slide="prev"><span class="carousel-control-prev-icon"></span></button>
        <button class="carousel-control-next" type="button" data-bs-target="#imageCarousel" data-bs-slide="next"><span class="carousel-control-next-icon"></span></button>
    </div>

    <div class="profile-section d-flex align-items-center">
        <img src="/images/default_profile.png" id="sellerProfileImg" class="profile-img">
        <div class="flex-grow-1">
            <h5 class="m-0 fw-bold" id="sellerNickname">ë¡œë”©ì¤‘...</h5>
            <small class="text-muted"><i class="bi bi-geo-alt-fill" style="color: var(--sage-green);"></i> <span id="addressName">ì£¼ì†Œ ë¡œë”©ì¤‘...</span></small>
        </div>
        <div class="manner-temp-container">
            <span id="tempValue" class="temp-text">--.-â„ƒ</span>
            <div class="temp-bar-bg">
                <div id="tempBar" class="temp-bar-fill" style="width: 0%;"></div>
            </div>
            <button id="reportBtn" style="display: none;" class="btn btn-sm btn-link text-danger text-decoration-none p-0 mt-1" onclick="openReportModal()">ì‹ ê³ </button>
        </div>
    </div>

    <div class="content-section">
        <span class="badge mb-2" id="category" style="background-color: #e8f3ef; color: var(--sage-green); border-radius: 8px; padding: 6px 12px;">ì¹´í…Œê³ ë¦¬</span>
        <h2 class="fw-bold mb-3" id="title" style="color: #2d4a3e;">ì œëª© ë¡œë”©ì¤‘...</h2>
        <p id="description" class="mt-4" style="white-space: pre-line; color: #4b5563; line-height: 1.8; font-size: 1.1rem;">ë‚´ìš© ë¡œë”©ì¤‘...</p>
        <div class="text-muted mt-5 pt-4 border-top small d-flex gap-3">
            <span>ì¡°íšŒ <span id="viewCount" class="fw-bold">0</span></span>
            <span>ì°œ <span id="likeCount" class="fw-bold">0</span></span>
        </div>
    </div>
</div>

<footer th:replace="~{fragments/footer :: footer}"></footer>

<div class="bottom-bar">
    <div class="d-flex align-items-center gap-3">
        <button type="button" class="btn border-0 p-0" onclick="toggleWish()">
            <i id="wishIcon" class="bi bi-heart" style="font-size: 1.8rem; color: var(--warm-coral);"></i>
        </button>
        <div class="vr"></div>
        <span class="fw-bold fs-4" style="color: var(--sage-green);">ë¬´ë£Œë‚˜ëˆ”</span>
    </div>

    <div class="d-flex align-items-center gap-2">
        <div id="ownerButtons" style="display: none;" class="gap-2">
            <select id="statusSelect" class="form-select form-select-sm status-select-custom" onchange="changeStatus()">
                <option value="AVAILABLE">ë‚˜ëˆ”ì¤‘</option>
                <option value="RESERVED">ì˜ˆì•½ì¤‘</option>
                <option value="COMPLETED">ë‚˜ëˆ”ì™„ë£Œ</option>
            </select>
            <a id="editBtn" href="#" class="btn btn-outline-secondary btn-sm px-3 fw-bold" style="border-radius: 10px;">ìˆ˜ì •</a>
            <button id="deleteBtn" onclick="deleteItem()" class="btn btn-outline-danger btn-sm px-3 fw-bold" style="border-radius: 10px;">ì‚­ì œ</button>
        </div>

        <form id="chatForm" action="/chat/room" method="post" style="margin:0; display:none;">
            <input type="hidden" name="itemId" th:value="${itemId}">
        </form>
        <button id="chatBtn" type="button" class="btn btn-coral px-4 py-2 fw-bold" onclick="startChat()">ì±„íŒ…í•˜ê¸°</button>
    </div>
</div>

<div class="modal fade" id="reportModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="border-radius: 20px; border: none;">
            <div class="modal-header border-0 pb-0">
                <h5 class="fw-bold text-danger">ğŸš¨ ê²Œì‹œê¸€ ì‹ ê³ í•˜ê¸°</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="reportForm">
                    <div class="mb-3">
                        <label class="form-label small fw-bold">ì‹ ê³  ì‚¬ìœ </label>
                        <select id="reportReason" class="form-select" style="border-radius: 10px;">
                            <option value="FRAUD">ì‚¬ê¸° ê¸€ì´ì—ìš”</option>
                            <option value="ABUSIVE">ìš•ì„¤/ë¹„ë°©ì„ í•´ìš”</option>
                            <option value="ADVERTISING">ê´‘ê³ /í™ë³´ ê¸€ì´ì—ìš”</option>
                            <option value="OTHER">ê¸°íƒ€</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label small fw-bold">ìƒì„¸ ë‚´ìš©</label>
                        <textarea id="reportDescription" class="form-control" rows="4" placeholder="ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”." style="border-radius: 10px;"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 pt-0">
                <button type="button" class="btn btn-light px-4" data-bs-dismiss="modal" style="border-radius: 10px;">ì·¨ì†Œ</button>
                <button type="button" class="btn btn-danger px-4" onclick="submitReport()" style="border-radius: 10px;">ì‹ ê³  ì ‘ìˆ˜</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script th:inline="javascript">
    const Toast = Swal.mixin({
        toast: true, position: 'top-end', showConfirmButton: false, timer: 1500, timerProgressBar: true
    });

    /*<![CDATA[*/
    // âŒ [ìˆ˜ì •] const loginUserId ì„ ì–¸ ì‚­ì œ (header.htmlì— ì´ë¯¸ ìˆìŒ)
    // const loginUserId = [[${session.userId}]];  <-- ì´ ì¤„ ì‚­ì œë¨

    // loginUserId ë³€ìˆ˜ëŠ” header.html ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì „ì—­ìœ¼ë¡œ ì„ ì–¸ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ë°”ë¡œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
    const itemId = [[${itemId}]];
    /*]]>*/

    document.addEventListener("DOMContentLoaded", () => {
        fetch(`/api/items/${itemId}?userId=${loginUserId || 0}`)
            .then(res => res.json())
            .then(item => {
                document.getElementById('title').innerText = item.title;
                document.getElementById('description').innerText = item.description;
                document.getElementById('category').innerText = item.category;
                document.getElementById('addressName').innerText = item.addressName;
                document.getElementById('viewCount').innerText = item.viewCount;
                document.getElementById('likeCount').innerText = item.likeCount;
                document.getElementById('sellerNickname').innerText = item.sellerNickname;
                document.getElementById('reportSellerId').value = item.sellerId;

                const profileImg = document.getElementById('sellerProfileImg');
                profileImg.src = item.sellerProfileImage || '/images/default_profile.png';

                const wishIcon = document.getElementById('wishIcon');
                wishIcon.className = item.liked ? 'bi bi-heart-fill' : 'bi bi-heart';

                const temp = item.sellerMannerTemp || 36.5;
                const tempValue = document.getElementById('tempValue');
                const tempBar = document.getElementById('tempBar');

                tempValue.innerText = temp.toFixed(1) + "â„ƒ";
                tempBar.style.width = Math.min(temp, 100) + "%";

                if (temp >= 50) { tempValue.className = 'temp-text temp-hot'; tempBar.className = 'temp-bar-fill bg-hot'; }
                else if (temp >= 36.5) { tempValue.className = 'temp-text temp-warm'; tempBar.className = 'temp-bar-fill bg-warm'; }
                else if (temp >= 30) { tempValue.className = 'temp-text temp-normal'; tempBar.className = 'temp-bar-fill bg-normal'; }
                else { tempValue.className = 'temp-text temp-cold'; tempBar.className = 'temp-bar-fill bg-cold'; }

                if (loginUserId && loginUserId === item.sellerId) {
                    const ownerButtons = document.getElementById('ownerButtons');
                    const statusSelect = document.getElementById('statusSelect');
                    const editBtn = document.getElementById('editBtn');
                    const deleteBtn = document.getElementById('deleteBtn');

                    ownerButtons.style.display = 'flex';
                    document.getElementById('chatBtn').style.display = 'none';

                    editBtn.href = `/items/${item.itemId}/edit`;
                    statusSelect.value = item.status || 'AVAILABLE';

                    if (item.status === 'COMPLETED') {
                        statusSelect.disabled = true;
                        statusSelect.classList.add('bg-light', 'text-muted');
                        editBtn.classList.add('disabled');
                        deleteBtn.disabled = true;
                    }
                } else {
                    document.getElementById('chatForm').style.display = 'block';
                    if (loginUserId) document.getElementById('reportBtn').style.display = 'inline-block';
                }

                const carouselInner = document.getElementById('carouselInner');
                if (item.imageUrls && item.imageUrls.length > 0) {
                    item.imageUrls.forEach((url, index) => {
                        const activeClass = (index === 0) ? 'active' : '';
                        carouselInner.insertAdjacentHTML('beforeend',
                            `<div class="carousel-item ${activeClass}"><img src="/images/${url}" class="d-block w-100"></div>`);
                    });
                } else {
                    carouselInner.innerHTML = '<div class="carousel-item active"><img src="https://dummyimage.com/600x400/f0f0f0/999999.png?text=No+Image" class="d-block w-100"></div>';
                }
            });
    });

    function toggleWish() {
        if (!loginUserId) {
            Swal.fire({ icon: 'warning', title: 'ë¡œê·¸ì¸ í•„ìš”', showCancelButton: true, confirmButtonText: 'ë¡œê·¸ì¸', confirmButtonColor: '#5a8d7a' })
            .then(res => { if(res.isConfirmed) new bootstrap.Modal(document.getElementById('loginModal')).show(); });
            return;
        }

        fetch(`/api/items/${itemId}/like?userId=${loginUserId}`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            const wishIcon = document.getElementById('wishIcon');
            if (data.isLiked) {
                wishIcon.className = 'bi bi-heart-fill';
                Toast.fire({ icon: 'success', title: 'ì°œ ë“±ë¡!' });
            } else {
                wishIcon.className = 'bi bi-heart';
                Toast.fire({ icon: 'success', title: 'ì°œ ì·¨ì†Œ' });
            }
            document.getElementById('likeCount').innerText = data.likeCount;
        });
    }

    function changeStatus() {
        const status = document.getElementById('statusSelect').value;
        if (status === 'COMPLETED') {
            fetch(`/api/items/${itemId}/chat-partners`)
            .then(res => res.json())
            .then(partners => {
                if (partners.length === 0) {
                    Swal.fire('ì•Œë¦¼', 'ì±„íŒ…í•œ ì´ì›ƒì´ ì—†ì–´ ë‚˜ëˆ”ì„ ì™„ë£Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                    document.getElementById('statusSelect').value = 'AVAILABLE';
                    return;
                }
                const opt = {}; partners.forEach(u => opt[u.userId] = u.nickname);
                Swal.fire({ title: 'ë‚˜ëˆ” ëŒ€ìƒì ì„ íƒ', input: 'radio', inputOptions: opt, showCancelButton: true, confirmButtonColor: '#5a8d7a' })
                .then(res => {
                    if(res.isConfirmed) requestStatusChange(itemId, 'COMPLETED', res.value);
                    else document.getElementById('statusSelect').value = 'AVAILABLE';
                });
            });
        } else { requestStatusChange(itemId, status, null); }
    }

    function requestStatusChange(id, s, b) {
        let url = `/api/items/${id}/status?status=${s}`;
        if(b) url += `&buyerId=${b}`;
        fetch(url, { method: 'PATCH' }).then(res => { if(res.ok) Swal.fire('ì„±ê³µ', 'ìƒíƒœê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success').then(() => location.reload()); });
    }

    function deleteItem() {
        Swal.fire({
            title: 'ì •ë§ ì‚­ì œí• ê¹Œìš”?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#ff7e67',
            confirmButtonText: 'ì‚­ì œ'
        }).then(res => {
            if(res.isConfirmed) {
                fetch(`/api/items/${itemId}`, { method: 'DELETE' })
                .then(res => {
                    if(res.ok) {
                        Swal.fire('ì‚­ì œ ì™„ë£Œ', 'ê²Œì‹œê¸€ì´ ì •ìƒì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success')
                            .then(() => location.href = '/');
                    } else {
                        Swal.fire('ì‹¤íŒ¨', 'ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                    }
                });
            }
        });
    }

    function startChat() {
        if (!loginUserId) {
            Swal.fire({ icon: 'warning', title: 'ë¡œê·¸ì¸ í•„ìš”', text: 'ì±„íŒ…í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.', showCancelButton: true, confirmButtonColor: '#5a8d7a', confirmButtonText: 'ë¡œê·¸ì¸' })
            .then(res => { if(res.isConfirmed) new bootstrap.Modal(document.getElementById('loginModal')).show(); });
            return;
        }
        document.getElementById('chatForm').submit();
    }

    function openReportModal() { new bootstrap.Modal(document.getElementById('reportModal')).show(); }

    function submitReport() {
        const r = document.getElementById('reportReason').value;
        const d = document.getElementById('reportDescription').value;
        fetch(`/api/reports?userId=${loginUserId}`, {
            method: 'POST', headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ reportedUserId: document.getElementById('reportSellerId').value, itemId: itemId, reason: r, description: d })
        }).then(res => { if(res.ok) Swal.fire('ì‹ ê³  ì ‘ìˆ˜', 'ì •ìƒ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success').then(() => location.reload()); });
    }
</script>

<input type="hidden" id="reportSellerId" value="">
<input type="hidden" id="itemId" th:value="${itemId}">

</body>
</html>