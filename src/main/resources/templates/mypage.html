<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>ë§ˆì´í˜ì´ì§€ - Wegive</title>
    <link rel="stylesheet" as="style" crossorigin href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.css" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/header.css">
    <style>
        :root {
            --sage-green: #5a8d7a;
            --soft-sage: #e8f3ef;
            --warm-coral: #ff7e67;
            --cream-white: #fdfcf9;
            --text-main: #2d4a3e;
        }

        body { background-color: var(--cream-white); padding-top: 20px; padding-bottom: 50px; font-family: 'Pretendard', sans-serif; }

        .profile-card {
            background: white; border-radius: 25px; padding: 40px 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.03); text-align: center; margin-bottom: 30px;
            border: 1px solid rgba(90, 141, 122, 0.1);
        }
        .profile-img-container { position: relative; width: 110px; height: 110px; margin: 0 auto 15px; cursor: pointer; }
        .profile-img { width: 100%; height: 100%; border-radius: 35px; object-fit: cover; border: 4px solid var(--soft-sage); transition: all 0.3s ease; }
        .profile-img-container:hover .profile-img { opacity: 0.7; filter: brightness(0.8); }
        .profile-img-container::after {
            content: "ë³€ê²½"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            color: white; font-weight: bold; opacity: 0; transition: all 0.3s ease;
        }
        .profile-img-container:hover::after { opacity: 1; }

        .temp-bar-bg { width: 100%; height: 6px; background: #eee; border-radius: 10px; overflow: hidden; margin-top: 5px; }
        .temp-bar-fill { height: 100%; background: var(--sage-green); border-radius: 10px; transition: width 0.5s ease; }

        .nav-tabs .nav-link.active { background: var(--sage-green) !important; color: white !important; }
        .item-thumb { width: 75px; height: 75px; border-radius: 18px; object-fit: cover; }

        .status-select-custom {
            appearance: none; -webkit-appearance: none;
            background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%235a8d7a' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
            background-repeat: no-repeat; background-position: right 0.5rem center; background-size: 10px 10px;
            border-radius: 12px; border: 2px solid var(--sage-green); color: var(--sage-green);
            font-size: 0.85rem; font-weight: 700; padding: 5px 25px 5px 10px; cursor: pointer; background-color: white;
        }

        .footer-links { margin-top: 40px; border-top: 1px solid #eee; padding-top: 20px; }
        .btn-logout { color: #888; text-decoration: none; font-weight: 600; margin-right: 20px; }
        .btn-withdraw {
            color: var(--warm-coral); border: 1.5px solid var(--warm-coral);
            padding: 6px 15px; border-radius: 12px; font-size: 0.85rem;
            font-weight: 700; text-decoration: none; transition: all 0.3s;
        }
        .btn-withdraw:hover { background: var(--warm-coral); color: white; }
    </style>
</head>
<body>

<div class="container" style="max-width: 800px;">
    <div th:replace="~{fragments/header :: header}"></div>

    <div class="profile-card">
        <div class="profile-img-container" onclick="document.getElementById('profileInput').click()">
            <img th:src="${data.profileImg != null ? data.profileImg : '/images/default_profile.png'}" class="profile-img" alt="í”„ë¡œí•„">
        </div>
        <input type="file" id="profileInput" style="display: none;" accept="image/*" onchange="uploadProfileImage(this)">

        <div class="d-flex align-items-center justify-content-center mb-2">
            <h3 class="fw-bold mb-0 me-2" id="nicknameDisplay" th:text="${data.nickname}">ì‚¬ìš©ì</h3>
            <button type="button" class="btn btn-link p-0 text-decoration-none" onclick="editNickname()">
                <i class="bi bi-pencil-square" style="color: var(--sage-green); font-size: 1.2rem;"></i>
            </button>
        </div>

        <div class="mb-4">
            <span class="badge" style="background-color: var(--soft-sage); color: var(--text-main); font-size: 0.9rem; padding: 8px 15px; border-radius: 12px;">
                <i class="bi bi-geo-alt-fill" style="color: var(--sage-green);"></i>
                <span th:text="${data.addressName != null ? data.addressName : 'ë™ë„¤ ì¸ì¦ í•„ìš”'}">ì—­ì‚¼ë™</span>
                <button class="btn btn-link p-0 ms-2 text-decoration-none fw-bold" onclick="verifyLocation()"
                        style="color: var(--sage-green); font-size: 0.8rem;">
                    <i class="bi bi-arrow-clockwise"></i> ì¬ì¸ì¦
                </button>
            </span>
        </div>

        <div class="manner-section mx-auto" style="max-width: 200px;">
            <div class="d-flex justify-content-between small fw-bold">
                <span style="color: #888;">ë§¤ë„ˆì˜¨ë„</span>
                <span style="color: var(--sage-green);"><span th:text="${data.mannerTemp}">36.5</span>â„ƒ</span>
            </div>
            <div class="temp-bar-bg">
                <div class="temp-bar-fill" th:style="|width: ${data.mannerTemp}%|"></div>
            </div>
        </div>
    </div>

    <ul class="nav nav-tabs nav-fill mb-4" id="myTab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#share">ğŸ“¦ ë‚˜ì˜ ë‚˜ëˆ”</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#received">ğŸ ë°›ì€ ë‚´ì—­</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#wish">â¤ï¸ ê´€ì‹¬ ëª©ë¡</button></li>
    </ul>

    <div class="tab-content bg-white p-4 shadow-sm" style="border-radius: 20px;">
        <div class="tab-pane fade show active" id="share" role="tabpanel">
            <div th:if="${#lists.isEmpty(data.mySharingItems)}" class="text-center py-5">
                <div style="font-size: 3rem;">ğŸŒ±</div>
                <p class="text-muted fw-bold">ì•„ì§ ë‚˜ëˆ”í•œ ë¬¼í’ˆì´ ì—†ì–´ìš”.</p>
                <a href="/items/new" class="btn text-white px-4 fw-bold" style="background: var(--sage-green); border-radius: 15px;">ë‚˜ëˆ” ì‹œì‘í•˜ê¸°</a>
            </div>
            <ul class="list-group list-group-flush" th:unless="${#lists.isEmpty(data.mySharingItems)}">
                <li class="list-group-item d-flex gap-3 align-items-center" th:each="item : ${data.mySharingItems}" th:if="${item.status != 'DELETE' and item.status != 'HIDDEN'}">
                    <img th:src="${#lists.isEmpty(item.imageUrls) ? 'https://dummyimage.com/100x100/f0f0f0/999999.png?text=No+Image' : '/images/' + item.imageUrls[0]}" class="item-thumb">
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="item-title m-0 text-truncate" style="max-width: 200px; cursor: pointer;" th:text="${item.title}" th:onclick="|location.href='@{/items/{id}(id=${item.itemId})}'|">ì œëª©</h5>
                            <div th:if="${item.status != 'COMPLETED'}">
                                <select class="status-select-custom" th:onchange="|changeStatus(${item.itemId}, this.value)|">
                                    <option value="AVAILABLE" th:selected="${item.status == 'AVAILABLE'}">ë‚˜ëˆ”ì¤‘</option>
                                    <option value="RESERVED" th:selected="${item.status == 'RESERVED'}">ì˜ˆì•½ì¤‘</option>
                                </select>
                            </div>
                            <span th:if="${item.status == 'COMPLETED'}" class="badge rounded-pill px-3 py-2" style="background: #f0f0f0; color: #aaa;">ë‚˜ëˆ”ì™„ë£Œ</span>
                        </div>
                        <div class="mt-2 small fw-bold text-muted" th:text="${#temporals.format(item.createdAt, 'yyyy-MM-dd')}">ë‚ ì§œ</div>
                    </div>
                </li>
            </ul>
        </div>

        <div class="tab-pane fade" id="received" role="tabpanel">
            <div th:if="${#lists.isEmpty(data.myReceivedItems)}" class="text-center py-5 text-muted">
                <div style="font-size: 3rem;">ğŸ</div>
                <p class="fw-bold">ë‚˜ëˆ” ë°›ì€ ë‚´ì—­ì´ ì•„ì§ ì—†ë„¤ìš”.</p>
            </div>
            <ul class="list-group list-group-flush" th:unless="${#lists.isEmpty(data.myReceivedItems)}">
                <li class="list-group-item d-flex gap-3 align-items-center" th:each="item : ${data.myReceivedItems}">
                    <img th:src="${#lists.isEmpty(item.imageUrls) ? '/images/no_image.png' : '/images/' + item.imageUrls[0]}" class="item-thumb">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <h5 class="item-title m-0" th:text="${item.title}">ì œëª©</h5>
                                <p class="text-muted m-0 small mt-1 fw-bold">
                                    <span th:text="${item.sellerNickname}" style="color: var(--sage-green);">ë‚˜ëˆ”ì´</span>ë‹˜ì—ê²Œ ì„ ë¬¼ë°›ìŒ
                                </p>
                            </div>
                            <button th:if="${!item.isReviewed}" class="btn btn-sm px-3 fw-bold" style="background: var(--warm-coral); color: white; border-radius: 12px; border: none;" th:onclick="|sendThanks(${item.itemId})|">
                                <i class="bi bi-heart-fill"></i> ë‚˜ëˆ”ë°›ê¸° ì™„ë£Œ
                            </button>
                            <span th:if="${item.isReviewed}" class="text-muted small fw-bold">
                                <i class="bi bi-check-circle-fill" style="color: var(--sage-green);"></i> ë‚˜ëˆ” ë°›ê¸° ì™„ë£Œ
                            </span>
                        </div>
                    </div>
                </li>
            </ul>
        </div>

        <div class="tab-pane fade" id="wish" role="tabpanel">
            <div th:if="${#lists.isEmpty(data.myWishes)}" class="text-center py-5 text-muted">
                <div style="font-size: 3rem;">â¤ï¸</div>
                <p class="fw-bold">ì°œí•œ ë‚˜ëˆ”ì´ ì—†ì–´ìš”.</p>
            </div>
            <ul class="list-group list-group-flush" th:unless="${#lists.isEmpty(data.myWishes)}">
                <li class="list-group-item d-flex justify-content-between align-items-center" th:each="wish : ${data.myWishes}" th:id="'wish-item-' + ${wish.itemId}">
                    <div style="cursor: pointer;" th:onclick="|location.href='@{/items/{id}(id=${wish.itemId})}'|">
                        <h5 class="item-title m-0" th:text="${wish.itemTitle}">ì œëª©</h5>
                        <small class="text-muted fw-bold" th:text="|ì°œí•œ ë‚ ì§œ: ${#temporals.format(wish.createdAt, 'yyyy-MM-dd')}|">ë‚ ì§œ</small>
                    </div>
                    <button class="btn btn-outline-danger btn-sm rounded-pill border-0 fw-bold" th:onclick="|cancelWish(${wish.itemId})|">ì‚­ì œ</button>
                </li>
            </ul>
        </div>
    </div>

    <div class="text-center footer-links">
        <a href="/logout" class="btn-logout">ë¡œê·¸ì•„ì›ƒ</a>
        <a href="#" onclick="withdrawUser()" class="btn-withdraw">
            <i class="bi bi-person-x-fill"></i> íšŒì› íƒˆí‡´
        </a>
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script th:inline="javascript">
    const userId = [[${session.userId}]];

    // ğŸ“ ë™ë„¤ ì¬ì¸ì¦ ë¡œì§ (JSëŠ” ê¸°ì¡´ëŒ€ë¡œ ìœ ì§€í•˜ë˜, ì„œë²„ì—ì„œ addressNameì„ ê°±ì‹ í•´ì¤˜ì•¼ í•¨)
    function verifyLocation() {
        if (!navigator.geolocation) return Swal.fire('ì˜¤ë¥˜', 'ìœ„ì¹˜ ì •ë³´ë¥¼ ì§€ì›í•˜ì§€ ì•ŠëŠ” ë¸Œë¼ìš°ì €ì…ë‹ˆë‹¤.', 'error');
        Swal.fire({ title: 'ìœ„ì¹˜ í™•ì¸ ì¤‘...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

        navigator.geolocation.getCurrentPosition(
            (pos) => {
                fetch(`/api/users/${userId}/location?lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`, { method: 'PATCH' })
                .then(res => { if (res.ok) return res.text(); throw new Error(); })
                .then(msg => Swal.fire({ icon: 'success', title: 'ì¸ì¦ ì™„ë£Œ!', text: msg, confirmButtonColor: '#5a8d7a' }).then(() => location.reload()))
                .catch(() => Swal.fire('ì‹¤íŒ¨', 'ìœ„ì¹˜ ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error'));
            },
            () => Swal.fire('ì‹¤íŒ¨', 'ìœ„ì¹˜ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.', 'warning')
        );
    }

    function editNickname() {
        const nicknameEl = document.getElementById('nicknameDisplay');
        const currentName = nicknameEl ? nicknameEl.innerText : "";

        Swal.fire({
            title: 'ë‹‰ë„¤ì„ ë³€ê²½',
            input: 'text',
            inputValue: currentName,
            showCancelButton: true,
            confirmButtonText: 'ë³€ê²½',
            cancelButtonText: 'ì·¨ì†Œ',
            confirmButtonColor: '#5a8d7a',
            inputValidator: (value) => {
                if (!value) return 'ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!';
                if (value.length > 10) return 'ë‹‰ë„¤ì„ì€ 10ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”!';
            }
        }).then((result) => {
            if (result.isConfirmed) {
                const newNickname = result.value;

                // ğŸ“ [ì¶”ê°€ 1] ë³€ê²½ ì‚¬í•­ì´ ì—†ëŠ” ê²½ìš° (í˜„ì¬ ë‹‰ë„¤ì„ê³¼ ë™ì¼)
                if (newNickname === currentName) {
                    return Swal.fire({
                        icon: 'info',
                        title: 'ë³€ê²½ ì·¨ì†Œ',
                        text: 'í˜„ì¬ ë‹‰ë„¤ì„ê³¼ ë™ì¼í•©ë‹ˆë‹¤.',
                        confirmButtonColor: '#5a8d7a'
                    });
                }

                // ğŸ“ [ì¶”ê°€ 2] ì—ëŸ¬ í•¸ë“¤ë§ ë¡œì§ ë³µêµ¬
                fetch(`/api/users/${userId}/nickname?nickname=${newNickname}`, { method: 'PATCH' })
                .then(async res => {
                    if (res.ok) {
                        Swal.fire({
                            icon: 'success',
                            title: 'ë³€ê²½ ì™„ë£Œ',
                            confirmButtonColor: '#5a8d7a'
                        }).then(() => location.reload());
                    } else {
                        // ì„œë²„ì—ì„œ ë³´ë‚¸ ì—ëŸ¬ ë©”ì‹œì§€ ë°›ì•„ì„œ ì¶œë ¥
                        const errorMsg = await res.text();
                        Swal.fire({
                            icon: 'warning',
                            title: 'ë³€ê²½ ì‹¤íŒ¨',
                            text: errorMsg || 'ë‹‰ë„¤ì„ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', // ë©”ì‹œì§€ê°€ ë¹„ì–´ìˆì„ ê²½ìš° ëŒ€ë¹„
                            confirmButtonColor: '#5a8d7a'
                        });
                    }
                })
                .catch(err => {
                    console.error(err);
                    Swal.fire('ì˜¤ë¥˜', 'ì„œë²„ í†µì‹  ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                });
            }
        });
    }

    function uploadProfileImage(input) {
        if (!input.files || !input.files[0]) return;
        const formData = new FormData();
        formData.append('profileImage', input.files[0]);
        fetch(`/api/users/${userId}/profileImage`, { method: 'POST', body: formData })
        .then(res => { if (res.ok) location.reload(); });
    }

    function cancelWish(itemId) {
        fetch(`/api/wishes/item/${itemId}?userId=${userId}`, { method: 'POST' })
        .then(res => {
            if(res.ok) {
                const listItem = document.getElementById('wish-item-' + itemId);
                if (listItem) listItem.remove();
                if(document.querySelectorAll('#wish .list-group-item').length === 0) location.reload();
            }
        });
    }

    function sendThanks(itemId) {
        Swal.fire({
            title: 'ë‚˜ëˆ” ë°›ê¸° ì™„ë£Œ', text: "ë‚˜ëˆ” ì˜ ë°›ìœ¼ì…¨ë‚˜ìš”?", icon: 'question',
            showCancelButton: true, confirmButtonText: 'ë„¤', confirmButtonColor: '#5a8d7a'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/api/items/${itemId}/review`, { method: 'POST' })
                .then(res => { if (res.ok) location.reload(); });
            }
        });
    }

    function changeStatus(itemId, newStatus) {
        fetch(`/api/items/${itemId}/status?status=${newStatus}`, { method: 'PATCH' })
        .then(res => { if (res.ok) location.reload(); });
    }

    function withdrawUser() {
        Swal.fire({
            title: 'ì •ë§ íƒˆí‡´í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', icon: 'warning',
            showCancelButton: true, confirmButtonColor: '#ff7e67', confirmButtonText: 'íƒˆí‡´í•˜ê¸°'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/api/users/${userId}`, { method: 'DELETE' })
                .then(res => { if (res.ok) location.href = '/'; });
            }
        });
    }
</script>
</body>
</html>